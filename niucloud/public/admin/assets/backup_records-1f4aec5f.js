import{d as Ge,v as He,r as d,l as he,X as Je,al as Oe,N as ke,h as c,c as f,e,w as a,a as p,t as i,u as n,i as v,k as t,J as R,m as V,B as ae,F as O,T as xe,n as P,ae as Q,a4 as L,Y as Qe,E as Xe,D as Ye,G as qe,H as Ae,L as Ke,a5 as We,ab as Ze,a6 as et,a7 as tt,at,au as lt,av as nt,aw as ot,Q as st,a2 as rt,a_ as it,S as ut,M as ct,p as dt,g as pt,_ as mt}from"./index-9f163f98.js";/* empty css                   *//* empty css                  *//* empty css                   *//* empty css                  *//* empty css                     *//* empty css               *//* empty css                *//* empty css                      *//* empty css                 *//* empty css               *//* empty css                  *//* empty css                  *//* empty css                  *//* empty css                 *//* empty css                    */import"./el-tooltip-4ed993c7.js";/* empty css                        *//* empty css                *//* empty css                */import"./el-form-item-4ed993c7.js";/* empty css                  */import{T as vt,_ as _t,b as ft,a as gt}from"./dark-d503b80a.js";import{d as ht,m as kt,f as xt,h as bt,r as yt,i as wt,j as be}from"./upgrade-e1e2708e.js";/* empty css                        */const ye=j=>(dt("data-v-ab587b59"),j=j(),pt(),j),Ct={class:"main-container"},Tt={class:"flex justify-between items-center"},Et={class:"text-page-title"},Bt={key:0,class:"multi-hidden"},It={key:1,class:"multi-hidden"},St={key:2,class:"multi-hidden"},Dt={key:0,class:"multi-hidden"},$t={key:1},Rt={class:"mt-[10px] flex items-center"},Vt={class:"mt-[16px] flex justify-end"},Ft={class:"h-[400px]",style:{overflow:"auto"}},Mt={class:"flex flex-col"},Pt={class:"bg-[#fff] my-3"},Ut={class:"px-[20px] pt-[10px] text-[14px] el-table"},zt={key:0,style:{height:"calc(300px)",overflow:"auto"}},Nt={key:1},Lt={style:{height:"calc(300px)",overflow:"auto"}},jt={class:"h-[370px] mt-[30px]"},Gt={class:"mt-[20px]"},Ht=ye(()=>p("img",{src:ft,alt:""},null,-1)),Jt={class:"mt-[20px] h-[370px]"},Ot=ye(()=>p("img",{src:gt,alt:""},null,-1)),Qt={key:0,class:"dialog-footer"},Xt={key:1,class:"dialog-footer"},Yt={class:"dialog-footer"},qt=Ge({__name:"backup_records",setup(j){const we=He(),Ce=d(Date.now()),Te=we.meta.title,le=d(),X=d([]),Ee=d(),x=d(!1);d(null);const u=he({page:1,limit:10,total:0,loading:!0,data:[],searchParam:{content:""}}),T=d(!1),m=d("check"),U=d(!1),g=d(null),E=d(null),Y=d(!1),F=d(!1),w=d(0),ne=d(0);let q=[],G=[];const Be=o=>{o&&(o.resetFields(),b())},Ie=o=>{X.value=o},b=(o=1)=>{u.loading=!0,u.page=o,ht({page:u.page,limit:u.limit,...u.searchParam}).then(l=>{u.loading=!1,u.data=l.data.data,u.total=l.data.total}).catch(()=>{u.loading=!1})};b();const B=d(0),Se=()=>{L.confirm(t("manualBackupTips"),t("warning"),{confirmButtonText:t("confirm"),cancelButtonText:t("cancel"),type:"warning"}).then(()=>{q=[],w.value=0,B.value=1,T.value=!0,F.value=!0,m.value="check",U.value=!1,se()})},H=d(!1),h=d(null),I=d(0);let _=null;const A=Je(()=>{const o=I.value,l=Math.floor(o/60),r=o%60;return l>0?`${l}分${r}秒`:`${r}秒`}),K=d(""),oe=(o="")=>{U.value||(o==""&&(w.value=1,m.value="execute"),kt({task:o}).then(l=>{const r=l.data;if(o==""){E.value.execute("clear"),E.value.execute("开始执行"),H.value=!0;const k=localStorage.getItem("manual_back_start_time");if(k)h.value=Number(k);else{const y=Date.now();h.value=y,localStorage.setItem("manual_back_start_time",String(y))}I.value=Math.floor((Date.now()-h.value)/1e3),_&&clearInterval(_),_=setInterval(()=>{h.value&&(I.value=Math.floor((Date.now()-h.value)/1e3))},1e3)}r.content&&!q.includes(r.content)&&(q.push(r.content),E.value.pushMessage({content:`${r.content}`})),r.task=="end"?(w.value=2,setTimeout(()=>{w.value=3,m.value="complete",H.value=!0,_&&clearInterval(_),localStorage.removeItem("manual_back_start_time"),b(),x.value=!1},1500)):r.task=="fail"?(setTimeout(()=>{b(),x.value=!1},2e3),K.value=r.content,m.value="error",H.value=!0,_&&(clearInterval(_),_=null),h.value&&(I.value=Math.floor((Date.now()-h.value)/1e3)),localStorage.removeItem("manual_back_start_time")):setTimeout(()=>{oe(r.task)},2e3)}).catch(()=>{x.value=!1,u.loading=!1}))},De=o=>{L.confirm(t("restoreTips"),t("warning"),{confirmButtonText:t("confirm"),cancelButtonText:t("cancel"),type:"warning"}).then(()=>{w.value=0,G=[],B.value=2,ne.value=o.id,m.value="check",U.value=!1,$e(o.id)})},$e=o=>{xt({id:o}).then(({data:l})=>{l&&(T.value=!0,F.value=!0,se())})},se=()=>{bt({}).then(({data:o})=>{g.value=o,Y.value=!o.is_pass,F.value=!1})},re=(o,l="")=>{U.value||(l==""&&(w.value=1,m.value="execute"),yt({id:o,task:l}).then(r=>{const k=r.data;if(l==""){F.value=!1,E.value.execute("clear"),E.value.execute("开始执行");const y=localStorage.getItem("manual_back_start_time");if(y)h.value=Number(y);else{const $=Date.now();h.value=$,localStorage.setItem("manual_back_start_time",String($))}I.value=Math.floor((Date.now()-h.value)/1e3),_&&clearInterval(_),_=setInterval(()=>{h.value&&(I.value=Math.floor((Date.now()-h.value)/1e3))},1e3)}k.content&&!G.includes(k.content)&&(G.push(k.content),E.value.pushMessage({content:`${k.content}`})),k.task=="end"?(w.value=2,setTimeout(()=>{w.value=3,m.value="complete",_&&clearInterval(_),localStorage.removeItem("manual_back_start_time"),b(),x.value=!1},1500)):k.task=="fail"?(setTimeout(()=>{b(),x.value=!1},2e3),K.value=k.content,m.value="error",_&&(clearInterval(_),_=null),h.value&&(I.value=Math.floor((Date.now()-h.value)/1e3)),localStorage.removeItem("manual_back_start_time")):setTimeout(()=>{G=[],re(o,k.task)},2e3)}).catch(()=>{x.value=!1,u.loading=!1}))},ie=d(!1),ue=()=>{m.value="execute",ie.value=!0},Re=o=>{m.value=="execute"&&!ie.value?L.confirm(t("showDialogCloseTips"),t("warning"),{confirmButtonText:t("confirm"),cancelButtonText:t("cancel"),type:"warning"}).then(()=>{E.value.execute("clear"),U.value=!0,o(),localStorage.removeItem("manual_back_start_time"),_&&clearInterval(_),_=null,h.value=null,I.value=0}).catch(()=>{}):(m.value=="complete"&&setTimeout(()=>{location.reload()},500),o())};let W=null;const ce=new vt,Ve=(o,l,r,k,y)=>{if(l=="开始执行"){r(ce);const $=Fe(["/","——","\\","|"]);W=setInterval(()=>{ce.flush("> "+$.next().value)},150)}},Fe=o=>{let l=0;return{next(){return l+1==o.length&&(l=0),{value:o[l++]}}}};Oe(()=>T.value,()=>{T.value||(m.value="execute",W&&clearInterval(W))});const z=d(!1),N=d(!1),D=he({id:0,remark:""}),Me=o=>{D.id=o.id,D.remark=o.remark,z.value=!0},Pe=()=>{N.value=!0,wt({id:D.id,remark:D.remark}).then(()=>{z.value=!1,N.value=!1,b()}).catch(()=>{N.value=!1})},Ue=o=>{L.confirm(t("deleteTips"),t("warning"),{confirmButtonText:t("confirm"),cancelButtonText:t("cancel"),type:"warning"}).then(()=>{x.value||(x.value=!0,u.loading=!0,be({ids:o}).then(()=>{b(),x.value=!1}).catch(()=>{x.value=!1,u.loading=!1}))})},ze=()=>{if(X.value.length==0){Qe({type:"warning",message:`${t("batchEmptySelectedTips")}`});return}L.confirm(t("deleteTips"),t("warning"),{confirmButtonText:t("confirm"),cancelButtonText:t("cancel"),type:"warning"}).then(()=>{if(u.loading=!0,x.value)return;x.value=!0;const o=[];X.value.forEach(l=>{o.push(l.id)}),be({ids:o}).then(()=>{b(),x.value=!1}).catch(()=>{x.value=!1,u.loading=!1})})};return(o,l)=>{const r=Xe,k=Ye,y=qe,$=Ae,de=Ke,S=We,Z=Ze,Ne=et,Le=tt,M=at,je=lt,C=nt,ee=ot,pe=ke("Select"),J=st,me=ke("CloseBold"),ve=rt,_e=it,fe=ut,te=ct;return c(),f("div",Ct,[e(de,{class:"box-card !border-none",shadow:"never"},{default:a(()=>[p("div",Tt,[p("span",Et,i(n(Te)),1),e(r,{type:"primary",onClick:Se},{default:a(()=>[v(i(n(t)("manualBackup")),1)]),_:1})]),e(de,{class:"box-card !border-none my-[10px] table-search-wrap",shadow:"never"},{default:a(()=>[e($,{inline:!0,model:u.searchParam,ref_key:"searchFormRef",ref:le},{default:a(()=>[e(y,{label:n(t)("content"),prop:"content"},{default:a(()=>[e(k,{modelValue:u.searchParam.content,"onUpdate:modelValue":l[0]||(l[0]=s=>u.searchParam.content=s),modelModifiers:{trim:!0},placeholder:n(t)("contentPlaceholder")},null,8,["modelValue","placeholder"])]),_:1},8,["label"]),e(y,null,{default:a(()=>[e(r,{type:"primary",onClick:l[1]||(l[1]=s=>b())},{default:a(()=>[v(i(n(t)("search")),1)]),_:1}),e(r,{onClick:l[2]||(l[2]=s=>Be(le.value))},{default:a(()=>[v(i(n(t)("reset")),1)]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),R((c(),V(Ne,{data:u.data,size:"large",ref_key:"tableRef",ref:Ee,onSelectionChange:Ie},{empty:a(()=>[p("span",null,i(u.loading?"":n(t)("emptyData")),1)]),default:a(()=>[e(S,{type:"selection",width:"55"}),e(S,{prop:"id",label:n(t)("id"),width:"120"},null,8,["label"]),e(S,{prop:"content",label:n(t)("操作"),width:"120",align:"left"},{default:a(({row:s})=>[s.content=="手动备份"?(c(),f("span",Bt,[e(Z,{type:"primary"},{default:a(()=>[v(i(s.content),1)]),_:2},1024)])):s.content=="自动备份"?(c(),f("span",It,[e(Z,{type:"success"},{default:a(()=>[v(i(s.content),1)]),_:2},1024)])):(c(),f("span",St,[e(Z,{type:"warning"},{default:a(()=>[v(i(s.content),1)]),_:2},1024)]))]),_:1},8,["label"]),e(S,{prop:"version",label:n(t)("currentVersion"),width:"120"},null,8,["label"]),e(S,{prop:"backup_dir",label:n(t)("backupDir"),width:"220"},null,8,["label"]),e(S,{prop:"complete_time",label:n(t)("completeTime"),width:"220"},null,8,["label"]),e(S,{prop:"remark",label:n(t)("remark")},{default:a(({row:s})=>[s.remark?(c(),f("span",Dt,i(s.remark),1)):(c(),f("span",$t,i(n(t)("remarkEmpty")),1))]),_:1},8,["label"]),e(S,{label:n(t)("operation"),align:"right",fixed:"right",width:"200"},{default:a(({row:s})=>[e(r,{type:"primary",link:"",onClick:ge=>Me(s)},{default:a(()=>[v(i(n(t)("remark")),1)]),_:2},1032,["onClick"]),e(r,{type:"primary",link:"",onClick:ge=>De(s)},{default:a(()=>[v(i(n(t)("restore")),1)]),_:2},1032,["onClick"]),e(r,{type:"primary",link:"",onClick:ge=>Ue(s.id)},{default:a(()=>[v(i(n(t)("delete")),1)]),_:2},1032,["onClick"])]),_:1},8,["label"])]),_:1},8,["data"])),[[te,u.loading]]),p("div",Rt,[e(r,{onClick:ze,size:"small"},{default:a(()=>[v(i(n(t)("batchDelete")),1)]),_:1})]),p("div",Vt,[e(Le,{"current-page":u.page,"onUpdate:current-page":l[3]||(l[3]=s=>u.page=s),"page-size":u.limit,"onUpdate:page-size":l[4]||(l[4]=s=>u.limit=s),layout:"total, sizes, prev, pager, next, jumper",total:u.total,onSizeChange:l[5]||(l[5]=s=>b()),onCurrentChange:b},null,8,["current-page","page-size","total"])])]),_:1}),e(fe,{modelValue:T.value,"onUpdate:modelValue":l[10]||(l[10]=s=>T.value=s),title:B.value==1?n(t)("manualBackupTitle"):n(t)("restoreTitle"),width:"850px","close-on-click-modal":!1,"close-on-press-escape":!1,"show-close":!0,"before-close":Re},{footer:a(()=>[m.value=="check"?(c(),f("div",Qt,[B.value==1?(c(),V(r,{key:0,type:"primary",loading:F.value,disabled:Y.value,onClick:l[8]||(l[8]=s=>oe())},{default:a(()=>[v(i(n(t)("nextStep")),1)]),_:1},8,["loading","disabled"])):(c(),V(r,{key:1,type:"primary",loading:F.value,disabled:Y.value,onClick:l[9]||(l[9]=s=>re(ne.value))},{default:a(()=>[v(i(n(t)("nextStep")),1)]),_:1},8,["loading","disabled"]))])):ae("",!0),m.value=="execute"?(c(),f("div",Xt,[e(r,{type:"primary",loading:H.value,class:"!w-[140px]"},{default:a(()=>[v("已用时 "+i(n(A)),1)]),_:1},8,["loading"])])):ae("",!0)]),default:a(()=>[m.value!="error"&&m.value!="complete"?(c(),V(je,{key:0,active:w.value,"align-center":"",class:"number-of-steps","finish-status":"success","process-status":"process"},{default:a(()=>[B.value==1?(c(),f(O,{key:0},[e(M,{title:n(t)("testDirectoryPermissions")},null,8,["title"]),e(M,{title:n(t)("startBackUp")},null,8,["title"]),e(M,{title:n(t)("backUpEnd")},null,8,["title"])],64)):(c(),f(O,{key:1},[e(M,{title:n(t)("testDirectoryPermissions")},null,8,["title"]),e(M,{title:n(t)("startUpgrade")},null,8,["title"]),e(M,{title:n(t)("upgradeEnd")},null,8,["title"])],64))]),_:1},8,["active"])):ae("",!0),p("div",Ft,[R(p("div",Mt,[e(ve,null,{default:a(()=>[p("div",Pt,[p("div",Ut,[e(ee,{class:"py-[10px] items table-head-bg pl-[15px] mb-[10px]"},{default:a(()=>[e(C,{span:18},{default:a(()=>[p("span",null,i(n(t)("upgrade.path")),1)]),_:1}),e(C,{span:3},{default:a(()=>[p("span",null,i(n(t)("upgrade.demand")),1)]),_:1}),e(C,{span:3},{default:a(()=>[p("span",null,i(n(t)("status")),1)]),_:1})]),_:1}),g.value&&g.value.dir?(c(),f("div",zt,[(c(!0),f(O,null,xe(g.value.dir.is_readable,s=>(c(),V(ee,{class:"pb-[10px] items pl-[15px]"},{default:a(()=>[e(C,{span:18},{default:a(()=>[p("span",null,i(s.dir),1)]),_:2},1024),e(C,{span:3},{default:a(()=>[p("span",{class:P({"mx-[10px]":g.value.dir.is_readable.length+g.value.dir.is_write.length>9})},i(n(t)("upgrade.readable")),3)]),_:1}),e(C,{span:3},{default:a(()=>[s.status?(c(),f("span",{key:0,class:P({"mx-[20px]":g.value.dir.is_readable.length+g.value.dir.is_write.length>9})},[e(J,{color:"green"},{default:a(()=>[e(pe)]),_:1})],2)):(c(),f("span",{key:1,class:P({"mx-[20px]":g.value.dir.is_readable.length+g.value.dir.is_write.length>9})},[e(J,{color:"red"},{default:a(()=>[e(me)]),_:1})],2))]),_:2},1024)]),_:2},1024))),256)),(c(!0),f(O,null,xe(g.value.dir.is_write,s=>(c(),V(ee,{class:"pb-[10px] items pl-[15px]"},{default:a(()=>[e(C,{span:18},{default:a(()=>[p("span",null,i(s.dir),1)]),_:2},1024),e(C,{span:3},{default:a(()=>[p("span",{class:P({"mx-[10px]":g.value.dir.is_readable.length+g.value.dir.is_write.length>9})},i(n(t)("upgrade.write")),3)]),_:1}),e(C,{span:3},{default:a(()=>[s.status?(c(),f("span",{key:0,class:P({"mx-[20px]":g.value.dir.is_readable.length+g.value.dir.is_write.length>9})},[e(J,{color:"green"},{default:a(()=>[e(pe)]),_:1})],2)):(c(),f("span",{key:1,class:P({"mx-[20px]":g.value.dir.is_readable.length+g.value.dir.is_write.length>9})},[e(J,{color:"red"},{default:a(()=>[e(me)]),_:1})],2))]),_:2},1024)]),_:2},1024))),256))])):(c(),f("div",Nt,[R(p("div",Lt,null,512),[[te,!0]])]))])])]),_:1})],512),[[Q,m.value=="check"]]),R(p("div",jt,[e(n(_t),{ref_key:"terminalRef",ref:E,name:`backup-restore-${Ce.value}`,context:"","init-log":null,"show-header":!1,"show-log-time":!0,onExecCmd:Ve},null,8,["name"])],512),[[Q,m.value=="execute"]]),R(p("div",Gt,[e(_e,{icon:"success",title:B.value==1?n(t)("backupCompleteTips"):n(t)("restoreCompleteTips"),"sub-title":B.value==1?`备份耗时${n(A)}，成功备份完成。`:`恢复耗时${n(A)}，成功恢复完成。`},{icon:a(()=>[Ht]),extra:a(()=>[e(r,{onClick:ue,class:"!w-[90px]"},{default:a(()=>[v("返回")]),_:1}),e(r,{onClick:l[6]||(l[6]=s=>T.value=!1),type:"primary",class:"!w-[90px]"},{default:a(()=>[v("完成")]),_:1})]),_:1},8,["title","sub-title"])],512),[[Q,m.value=="complete"]]),R(p("div",Jt,[e(_e,{icon:"success",title:B.value==1?n(t)("备份失败"):n(t)("恢复失败")},{icon:a(()=>[Ot]),extra:a(()=>[e(ve,{class:"max-h-[120px] !overflow-auto text-[15px] text-[#4F516D] mb-[15px] mt-[-15px]"},{default:a(()=>[v(i(K.value),1)]),_:1}),e(r,{onClick:ue,class:"!w-[90px]"},{default:a(()=>[v("错误信息")]),_:1}),e(r,{onClick:l[7]||(l[7]=s=>T.value=!1),type:"primary",class:"!w-[90px]"},{default:a(()=>[v("完成")]),_:1})]),_:1},8,["title"])],512),[[Q,m.value=="error"]])])]),_:1},8,["modelValue","title"]),e(fe,{modelValue:z.value,"onUpdate:modelValue":l[14]||(l[14]=s=>z.value=s),title:n(t)("remark"),width:"460px","destroy-on-close":!0},{footer:a(()=>[p("span",Yt,[e(r,{onClick:l[12]||(l[12]=s=>z.value=!1)},{default:a(()=>[v(i(n(t)("cancel")),1)]),_:1}),e(r,{type:"primary",loading:N.value,onClick:l[13]||(l[13]=s=>Pe())},{default:a(()=>[v(i(n(t)("confirm")),1)]),_:1},8,["loading"])])]),default:a(()=>[R((c(),V($,{model:D,ref:"formRef",class:"page-form"},{default:a(()=>[e(y,{class:"mb-0"},{default:a(()=>[e(k,{modelValue:D.remark,"onUpdate:modelValue":l[11]||(l[11]=s=>D.remark=s),modelModifiers:{trim:!0},rows:5,type:"textarea",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])),[[te,N.value]])]),_:1},8,["modelValue","title"])])}}});const ba=mt(qt,[["__scopeId","data-v-ab587b59"]]);export{ba as default};
